---
import { docsNav, contentBySlug } from "@levitate/docs-content"

interface Props {
	currentSlug: string
}

const { currentSlug } = Astro.props
const currentPath = `/docs/${currentSlug}`

function toAnchor(title: string): string {
	return title
		.toLowerCase()
		.replace(/[^a-z0-9\s-]/g, "")
		.replace(/\s+/g, "-")
}

// Find current page title for mobile dropdown
const currentTitle = docsNav
	.flatMap((section) => section.items)
	.find((item) => item.href === currentPath)?.title || "Documentation"
---

<!-- Mobile docs navigation -->
<div class="md:hidden mb-6">
	<button
		type="button"
		id="docs-nav-toggle"
		class="w-full flex items-center justify-between px-4 py-3 bg-muted rounded-lg text-left"
		aria-expanded="false"
	>
		<div class="flex items-center gap-2">
			<svg class="w-4 h-4 text-muted-foreground" viewBox="0 0 256 256" fill="currentColor">
				<path d="M224 48H32a8 8 0 0 0-8 8v136a16 16 0 0 0 16 16h176a16 16 0 0 0 16-16V56a8 8 0 0 0-8-8ZM40 64h40v128H40Zm176 128H96V64h120Z" />
			</svg>
			<span class="font-medium">{currentTitle}</span>
		</div>
		<svg class="docs-nav-chevron w-4 h-4 text-muted-foreground transition-transform" viewBox="0 0 256 256" fill="currentColor">
			<path d="M213.66 101.66l-80 80a8 8 0 0 1-11.32 0l-80-80a8 8 0 0 1 11.32-11.32L128 164.69l74.34-74.35a8 8 0 0 1 11.32 11.32Z" />
		</svg>
	</button>
	<nav
		id="docs-nav-mobile"
		class="hidden mt-2 bg-muted rounded-lg overflow-hidden"
	>
		{
			docsNav.map((section) => (
				<div class="border-b border-border last:border-b-0">
					<h3 class="font-semibold px-4 py-2 text-sm text-muted-foreground">{section.title}</h3>
					<ul>
						{section.items.map((item) => {
							const isActive = currentPath === item.href
							return (
								<li>
									<a
										href={item.href}
										class={`block px-4 py-2 text-sm transition-colors ${
											isActive
												? "bg-primary text-primary-foreground"
												: "text-foreground hover:bg-background"
										}`}
									>
										{item.title}
									</a>
								</li>
							)
						})}
					</ul>
				</div>
			))
		}
	</nav>
</div>

<!-- Desktop sidebar -->
<aside class="hidden md:block w-48 shrink-0 sticky top-20 h-[calc(100vh-6rem)]">
	<div class="h-full overflow-y-auto">
		<nav class="space-y-4 pr-4">
			{
				docsNav.map((section) => (
					<div>
						<h3 class="font-semibold mb-2">{section.title}</h3>
						<ul class="space-y-1">
							{section.items.map((item) => {
								const isActive = currentPath === item.href
								const slug = item.href.replace("/docs/", "")
								const content = contentBySlug[slug]
								const sections = content?.sections || []

								return (
									<li>
										<a
											href={item.href}
											data-active={isActive && sections.length > 0 ? "true" : undefined}
											class={`block px-3 py-1.5 text-sm transition-colors ${
												isActive
													? "bg-primary text-primary-foreground"
													: "text-muted-foreground hover:bg-muted hover:text-foreground"
											}`}
										>
											{item.title}
										</a>
										{isActive && sections.length > 0 && (
											<ul class="sidebar-subsections mt-1 ml-3 border-l border-border space-y-0.5">
												{sections.map((s) => (
													<li>
														<a
															href={`#${toAnchor(s.title)}`}
															class={`block px-3 py-1 text-xs transition-colors text-muted-foreground hover:text-foreground ${
																(s.level ?? 2) === 3 ? "pl-6" : ""
															}`}
														>
															{s.title}
														</a>
													</li>
												))}
											</ul>
										)}
									</li>
								)
							})}
						</ul>
					</div>
				))
			}
		</nav>
	</div>
</aside>

<script>
	// Mobile docs nav toggle
	const docsNavToggle = document.getElementById("docs-nav-toggle")
	const docsNavMobile = document.getElementById("docs-nav-mobile")
	const docsNavChevron = document.querySelector(".docs-nav-chevron")

	docsNavToggle?.addEventListener("click", () => {
		const isOpen = docsNavMobile?.classList.contains("hidden") === false
		docsNavMobile?.classList.toggle("hidden")
		docsNavChevron?.classList.toggle("rotate-180")
		docsNavToggle.setAttribute("aria-expanded", String(!isOpen))
	})

	// Desktop sidebar subsections toggle
	document.querySelectorAll('a[data-active="true"]').forEach((link) => {
		link.addEventListener("click", (e) => {
			const subsections = link.parentElement?.querySelector(".sidebar-subsections")
			if (subsections) {
				e.preventDefault()
				subsections.classList.toggle("hidden")
			}
		})
	})
</script>

<script>
	document.querySelectorAll('a[data-active="true"]').forEach((link) => {
		link.addEventListener("click", (e) => {
			const subsections = link.parentElement?.querySelector(".sidebar-subsections")
			if (subsections) {
				e.preventDefault()
				subsections.classList.toggle("hidden")
			}
		})
	})
</script>
