---
import Tabs from "./ui/Tabs.astro"
import TabContent from "./ui/TabContent.astro"
import LevitateTextLogo from "./brand/LevitateTextLogo.astro"
import RalphTextLogo from "./brand/RalphTextLogo.astro"
import AcornTextLogo from "./brand/AcornTextLogo.astro"

export interface ArchUrls {
	isoUrl?: string
	qcow2Url?: string
	imgUrl?: string
}

export type DownloadFormat = "iso" | "qcow2" | "img"

export interface Props {
	variant: "levitate" | "ralph" | "acorn"
	title: string
	logo: string
	stack: string
	description: string
	pros: string[]
	cons: string[]
	status: "available" | "coming-soon" | "planned"
	formats?: DownloadFormat[]
	x86_64?: ArchUrls
	aarch64?: ArchUrls
	x86_64Date: string
	aarch64Date: string
	minRam: string
	recRam: string
	minDisk: string
	recDisk: string
}

const {
	variant,
	title,
	logo,
	stack,
	description,
	pros,
	cons,
	status,
	formats,
	x86_64,
	aarch64,
	x86_64Date,
	aarch64Date,
	minRam,
	recRam,
	minDisk,
	recDisk,
} = Astro.props

const cardId = title.toLowerCase().replace(/\s+/g, '-')
const archTabs = [
	{ id: "x86_64", label: "x86_64" },
	{ id: "aarch64", label: "AArch64" },
]

const downloadFormats: DownloadFormat[] = formats?.length
	? formats
	: (["iso", "qcow2", "img"] as DownloadFormat[])
const primaryFormat: DownloadFormat = downloadFormats[0] ?? "qcow2"

function formatLabel(kind: DownloadFormat): string {
	switch (kind) {
		case "iso":
			return "ISO"
		case "qcow2":
			return "QCOW2"
		case "img":
			return "IMG"
	}
}

function getUrl(arch: ArchUrls | undefined, kind: DownloadFormat): string | undefined {
	switch (kind) {
		case "iso":
			return arch?.isoUrl
		case "qcow2":
			return arch?.qcow2Url
		case "img":
			return arch?.imgUrl
	}
}
---

<div class="ui-panel ui-lift overflow-hidden text-sm">
	<div class="flex flex-col sm:flex-row">
		<!-- OS Info -->
		<div class="px-5 py-5 flex flex-col flex-1">
			<div class="flex items-center gap-3 mb-2">
				<div class="size-10 shrink-0 grid place-items-center">
					<img
						src={logo}
						alt={title}
						loading="lazy"
						class="w-full h-full object-contain"
					/>
				</div>
				<h3 class="text-lg font-medium">
					{variant === "levitate" ? (
						<LevitateTextLogo className="text-lg" />
					) : variant === "ralph" ? (
						<RalphTextLogo className="text-lg" />
					) : (
						<AcornTextLogo className="text-lg" />
					)}
				</h3>
			</div>

			<p class="font-mono text-muted-foreground mb-2">{stack}</p>
			<p class="text-muted-foreground mb-3">{description}</p>

			<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
				<!-- Pros -->
				<ul class="space-y-1">
					{pros.map((pro) => (
						<li class="flex items-start gap-2">
							<span class="text-green-500 shrink-0">+</span>
							<span>{pro}</span>
						</li>
					))}
				</ul>

				<!-- Cons -->
				<ul class="space-y-1">
					{cons.map((con) => (
						<li class="flex items-start gap-2">
							<span class="text-red-400 shrink-0">âˆ’</span>
							<span>{con}</span>
						</li>
					))}
				</ul>
			</div>
		</div>

		<!-- Download -->
		<div class="bg-muted/40 dark:bg-black/20 px-5 py-5 flex flex-col sm:w-56 sm:shrink-0">
			<h4 class="font-medium mb-3">
				Download{" "}
				{variant === "levitate" ? (
					<LevitateTextLogo />
				) : variant === "ralph" ? (
					<RalphTextLogo />
				) : (
					<AcornTextLogo />
				)}
			</h4>
			<div class="text-muted-foreground mb-3">
				<table class="w-full">
					<thead>
						<tr class="text-muted-foreground/70">
							<td></td>
							<td class="text-right pb-0.5 pl-3">Min</td>
							<td class="text-right pb-0.5 pl-3">Rec</td>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td class="font-medium">RAM</td>
							<td class="text-right pl-3">{minRam}</td>
							<td class="text-right pl-3">{recRam}</td>
						</tr>
						<tr>
							<td class="font-medium">Disk</td>
							<td class="text-right pl-3">{minDisk}</td>
							<td class="text-right pl-3">{recDisk}</td>
						</tr>
					</tbody>
				</table>
			</div>

				<!-- Arch tabs -->
			<Tabs tabs={archTabs} name={cardId} defaultTab="x86_64" class="mt-auto mb-3" />

			<!-- x86_64 downloads -->
			<TabContent name={cardId} tabId="x86_64" default class="flex flex-col gap-2">
				{status === "available" && x86_64 ? (
					<>
						{downloadFormats.map((kind) => {
							const label = formatLabel(kind)
							const url = getUrl(x86_64, kind)
							const isPrimary = kind === primaryFormat
							const klass = isPrimary
								? "inline-flex items-center justify-center gap-2 bg-primary text-primary-foreground h-10 px-4 hover:bg-primary/90 transition-colors select-none"
								: "inline-flex items-center justify-center gap-2 bg-muted text-foreground h-10 px-4 hover:bg-muted/70 transition-colors select-none"

							return url ? (
								<a href={url} class={klass}>
									<svg class="size-5" viewBox="0 0 256 256" fill="currentColor">
										<path d="M224 152v56a16 16 0 0 1-16 16H48a16 16 0 0 1-16-16v-56a8 8 0 0 1 16 0v56h160v-56a8 8 0 0 1 16 0Zm-101.66 5.66a8 8 0 0 0 11.32 0l40-40a8 8 0 0 0-11.32-11.32L136 132.69V40a8 8 0 0 0-16 0v92.69l-26.34-26.35a8 8 0 0 0-11.32 11.32Z"/>
									</svg>
									{label}
								</a>
							) : (
								<span class="flex items-center justify-center bg-muted text-muted-foreground h-10 px-4 text-center">
									{label}
								</span>
							)
						})}
					</>
				) : (
					<>
						{downloadFormats.map((kind) => (
							<span class="flex items-center justify-center bg-muted text-muted-foreground h-10 px-4 text-center">
								{formatLabel(kind)}
							</span>
						))}
						<span class="text-xs text-muted-foreground text-center">{x86_64Date}</span>
					</>
				)}
			</TabContent>

			<!-- AArch64 downloads -->
			<TabContent name={cardId} tabId="aarch64" class="flex flex-col gap-2">
				{status === "available" && aarch64 ? (
					<>
						{downloadFormats.map((kind) => {
							const label = formatLabel(kind)
							const url = getUrl(aarch64, kind)
							const isPrimary = kind === primaryFormat
							const klass = isPrimary
								? "inline-flex items-center justify-center gap-2 bg-primary text-primary-foreground h-10 px-4 hover:bg-primary/90 transition-colors select-none"
								: "inline-flex items-center justify-center gap-2 bg-muted text-foreground h-10 px-4 hover:bg-muted/70 transition-colors select-none"

							return url ? (
								<a href={url} class={klass}>
									<svg class="size-5" viewBox="0 0 256 256" fill="currentColor">
										<path d="M224 152v56a16 16 0 0 1-16 16H48a16 16 0 0 1-16-16v-56a8 8 0 0 1 16 0v56h160v-56a8 8 0 0 1 16 0Zm-101.66 5.66a8 8 0 0 0 11.32 0l40-40a8 8 0 0 0-11.32-11.32L136 132.69V40a8 8 0 0 0-16 0v92.69l-26.34-26.35a8 8 0 0 0-11.32 11.32Z"/>
									</svg>
									{label}
								</a>
							) : (
								<span class="flex items-center justify-center bg-muted text-muted-foreground h-10 px-4 text-center">
									{label}
								</span>
							)
						})}
					</>
				) : (
					<>
						{downloadFormats.map((kind) => (
							<span class="flex items-center justify-center bg-muted text-muted-foreground h-10 px-4 text-center">
								{formatLabel(kind)}
							</span>
						))}
						<span class="text-xs text-muted-foreground text-center">{aarch64Date}</span>
					</>
				)}
			</TabContent>
		</div>
	</div>
</div>
