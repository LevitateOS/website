---
import type { RichText, InlineNode } from "@levitate/docs-content"

interface Props {
	content: string | RichText
}

const { content } = Astro.props

type InlinePart =
	| { type: "text"; content: string }
	| { type: "code"; content: string }
	| { type: "link"; content: string; href: string }
	| { type: "bold"; content: string }

function parseInlineContent(text: string): InlinePart[] {
	const parts: InlinePart[] = []
	const regex = /`([^`]+)`|\[([^\]]+)\]\(((?:[^()]+|\([^()]*\))+)\)|\*\*(.+?)\*\*/g
	let lastIndex = 0
	let match

	while ((match = regex.exec(text)) !== null) {
		if (match.index > lastIndex) {
			parts.push({ type: "text", content: text.slice(lastIndex, match.index) })
		}

		if (match[1]) {
			parts.push({ type: "code", content: match[1] })
		} else if (match[2] && match[3]) {
			parts.push({ type: "link", content: match[2], href: match[3] })
		} else if (match[4]) {
			parts.push({ type: "bold", content: match[4] })
		}

		lastIndex = match.index + match[0].length
	}

	if (lastIndex < text.length) {
		parts.push({ type: "text", content: text.slice(lastIndex) })
	}

	return parts.length > 0 ? parts : [{ type: "text", content: text }]
}

function renderInlineNode(node: InlineNode): string {
	if (typeof node === "string") {
		return node
	}
	switch (node.type) {
		case "link":
			return `<a href="${node.href}" class="text-primary hover:underline">${node.text}</a>`
		case "bold":
			return `<strong>${node.text}</strong>`
		case "code":
			return `<code class="bg-muted px-1.5 py-0.5">${node.text}</code>`
		case "italic":
			return `<em>${node.text}</em>`
		default:
			return ""
	}
}

function renderContent(content: string | RichText): string {
	if (Array.isArray(content)) {
		return content.map(renderInlineNode).join("")
	}

	const parts = parseInlineContent(content)
	return parts
		.map((part) => {
			if (part.type === "code") {
				return `<code class="bg-muted px-1.5 py-0.5">${part.content}</code>`
			}
			if (part.type === "link") {
				return `<a href="${part.href}" class="text-primary hover:underline">${part.content}</a>`
			}
			if (part.type === "bold") {
				return `<strong>${part.content}</strong>`
			}
			return part.content
		})
		.join("")
}

const renderedContent = renderContent(content)
---

<Fragment set:html={renderedContent} />
